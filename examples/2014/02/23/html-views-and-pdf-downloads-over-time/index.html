<!DOCTYPE html>
<html lang="en">
    <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML views and PDF downloads over time</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="Martin Fenner" />

    <!-- RDFa Metadata (in DublinCore) -->
    <meta property="dc:title" content="HTML views and PDF downloads over time" />
    <meta property="dc:creator" content="" />
    <meta name="citation_publication_date" content="2014-02-23T00:00:00+00:00"/>
    <meta property="dc:format" content="text/html" />
    <meta property="dc:language" content="en" />
    <meta property="dc:identifier" content="/examples/2014/02/23/html-views-and-pdf-downloads-over-time/" />
    <meta property="dc:rights" content="CC-BY" />
    <meta property="dc:source" content="Article-Level Metrics" />
    <meta property="dc:subject" content="Scholarly Communication" />
    <meta property="dc:type" content="website" />

    <!-- Google Scholar Metadata -->
    <meta name="citation_author" content="Martin Fenner"/>
    <meta name="citation_publication_date" content="2014-02-23"/>
    <meta name="citation_title" content="HTML views and PDF downloads over time"/>
    <meta name="citation_journal_title" content="Article-Level Metrics"/>

    <link rel="alternate" type="application/rss+xml" title="Article-Level Metrics" href="/rss.xml" />
    <link rel="alternate" type="application/atom+xml" title="Article-Level Metrics" href="/atom.xml" />

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,400italic,600italic' rel='stylesheet' type='text/css'>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/bootstrap-theme.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/github.css">

    <!-- Javascript -->
    <script src="/js/d3.v3.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">ALM</a>
    </div>
    <div class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="/">Introduction</a></li>
            <li><a href="/metrics">Metrics</a></li>
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Implementations <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="/plos">Public Library of Science</a></li>
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Development <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="/docs/">Home</a></li>
            <li><a href="/docs/installation">Installation</a></li>
            <li><a href="/docs/setup">Setup</a></li>
            <li><a href="/docs/sources">Sources</a></li>
            <li><a href="/docs/api">API</a></li>
            <li><a href="/docs/rake">Rake</a></li>
            <li><a href="/docs/alerts">Alerts</a></li>
            <li><a href="/docs/faq">FAQ</a></li>
            <li><a href="/docs/releases">Releases</a></li>
            <li><a href="/docs/roadmap">Roadmap</a></li>
            <li><a href="/docs/contributors">Contributors</a></li>
          </ul>
        </li>
        <li><a href="/examples">Examples</a></li>
        <li><a href="/blog">Blog</a></li>
        <li><a href="/status">Status</a></li>
      </ul>
    </div>
  </div>
</nav>
    <div class="container">
      <div class="page-header">
        <h1>HTML views and PDF downloads over time</h1>
        <p class="subtitle">23 February 2014 by
          
<a href="http://orcid.org/0000-0003-1419-2405">Martin Fenner</a>
        </p>
      </div>

      <div class="content">
        <div class="row">
          <div class="col-md-9">
            
            <p id="example2" data-api_key="Cyr783ZiaqNNe4ysByfj" data-doi="10.1371/journal.pmed.1000097">Usage data from the PLOS website for the article <a href="http://dx.doi.org/10.1371/journal.pmed.1000097">Preferred Reporting Items for Systematic Reviews and Meta-Analyses: The PRISMA Statement</a>, published July 2009. This article shows the ratio of HTML views to PDF downloads typical for PLOS but is unusual in that the usage data start to increase two years after publication. Data generated live from <a href="http://alm.plos.org">alm.plos.org</a>.</p>

<div id="example2"></div>

<script src="/js/alm.js"></script>

<h3 id="toc_0">Source code</h3>
<div class="highlight"><pre><code class="javascript language-javascript" data-lang="javascript"><span class="cm">/**</span>
<span class="cm"> * ALMViz</span>
<span class="cm"> * See https://github.com/articlemetrics/almviz for more details</span>
<span class="cm"> * Distributed under the GNU GPL v2. For full terms see the file docs/COPYING.</span>
<span class="cm"> *</span>
<span class="cm"> * @brief Article level metrics visualization controller.</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">AlmViz</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// allow jQuery object to be passed in</span>
    <span class="c1">// in case a different version of jQuery is needed from the one globally defined</span>
    <span class="nx">$</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">jQuery</span> <span class="o">||</span> <span class="nx">$</span><span class="p">;</span>

    <span class="c1">// Init data</span>
    <span class="kd">var</span> <span class="nx">groups_</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">groups</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">sources_</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">sources</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">almStatsJson</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">additionalStats</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">additionalStatsJson</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">additionalStats</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">sources</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">additionalStats</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Init basic options</span>
    <span class="kd">var</span> <span class="nx">baseUrl_</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">minItems_</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">minItemsToShowGraph</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">showTitle</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">showTitle</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">formatNumber_</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;,d&quot;</span><span class="p">);</span>

    <span class="c1">// extract publication date</span>
    <span class="kd">var</span> <span class="nx">pub_date</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">iso</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;publication_date&quot;</span><span class="p">]);</span>

    <span class="kd">var</span> <span class="nx">vizDiv</span><span class="p">;</span>
    <span class="c1">// Get the Div where the viz should go (default to one with ID &quot;alm&#39;)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">vizDiv</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">vizDiv</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">vizDiv</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">vizDiv</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#alm&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// look to make sure browser support SVG</span>
    <span class="kd">var</span> <span class="nx">hasSVG_</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">implementation</span><span class="p">.</span><span class="nx">hasFeature</span><span class="p">(</span><span class="s2">&quot;http://www.w3.org/TR/SVG11/feature#BasicStructure&quot;</span><span class="p">,</span> <span class="s2">&quot;1.1&quot;</span><span class="p">);</span>

    <span class="c1">// to track if any metrics have been found</span>
    <span class="kd">var</span> <span class="nx">metricsFound_</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Initialize the visualization.</span>
<span class="cm">     * NB: needs to be accessible from the outside for initialization</span>
<span class="cm">     */</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">initViz</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">vizDiv</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#loading&quot;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">showTitle</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">vizDiv</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">,</span> <span class="s1">&#39;http://dx.doi.org/&#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">doi</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">title</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// loop through groups</span>
        <span class="nx">groups_</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">group</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">addGroup_</span><span class="p">(</span><span class="nx">vizDiv</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="p">});</span>


        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">metricsFound_</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">vizDiv</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;text-muted&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;No metrics found.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>


    <span class="cm">/**</span>
<span class="cm">     * Build each article level statistics group.</span>
<span class="cm">     * @param {Object} canvas d3 element</span>
<span class="cm">     * @param {Array} group Information about the group.</span>
<span class="cm">     * @param {Object} data Statistics.</span>
<span class="cm">     * @return {JQueryObject|boolean}</span>
<span class="cm">     */</span>
    <span class="kd">var</span> <span class="nx">addGroup_</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">$groupRow</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

        <span class="c1">// Loop through sources to add statistics data to the group.</span>
        <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;sources&quot;</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">group_name</span> <span class="o">!=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">group</span><span class="p">.</span><span class="nx">sources</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="kd">var</span> <span class="nx">total</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">total</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="c1">// Only add the group row the first time</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">$groupRow</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">$groupRow</span> <span class="o">=</span> <span class="nx">getgroupRow_</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">group</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// Flag that there is at least one metric</span>
            <span class="nx">metricsFound_</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

            <span class="c1">// Some sources have multiple data</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">group_name</span> <span class="o">==</span> <span class="s2">&quot;viewed&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">html</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">addSource_</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">source</span><span class="p">.</span><span class="nx">display_name</span> <span class="o">+</span> <span class="s2">&quot; HTML&quot;</span><span class="p">,</span> <span class="nx">source</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">html</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="s2">&quot;html&quot;</span><span class="p">,</span> <span class="nx">$groupRow</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">pdf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">addSource_</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">source</span><span class="p">.</span><span class="nx">display_name</span> <span class="o">+</span> <span class="s2">&quot; PDF&quot;</span><span class="p">,</span> <span class="nx">source</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">pdf</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="nx">$groupRow</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">label</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">display_name</span><span class="p">;</span>
                  <span class="nx">addSource_</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">label</span><span class="p">,</span> <span class="nx">total</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="nx">$groupRow</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">};</span>


    <span class="cm">/**</span>
<span class="cm">     * Get group row d3 HTML element. It will automatically</span>
<span class="cm">     * add the element to the passed canvas.</span>
<span class="cm">     * @param {d3Object} canvas d3 HTML element</span>
<span class="cm">     * @param {Array} group group information.</span>
<span class="cm">     * @param {d3Object}</span>
<span class="cm">     */</span>
    <span class="kd">var</span> <span class="nx">getgroupRow_</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">group</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">groupRow</span><span class="p">,</span> <span class="nx">groupTitle</span><span class="p">,</span> <span class="nx">tooltip</span><span class="p">;</span>

        <span class="c1">// Build group html objects.</span>
        <span class="nx">groupRow</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;alm-group&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;group-&quot;</span> <span class="o">+</span> <span class="nx">group</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">groupRow</span><span class="p">;</span>
    <span class="p">};</span>


    <span class="cm">/**</span>
<span class="cm">     * Add source information to the passed group row element.</span>
<span class="cm">     * @param {Object} source</span>
<span class="cm">     * @param {integer} sourceTotalValue</span>
<span class="cm">     * @param {Object} group</span>
<span class="cm">     * @param {JQueryObject} $groupRow</span>
<span class="cm">     * @return {JQueryObject}</span>
<span class="cm">     */</span>
    <span class="kd">var</span> <span class="nx">addSource_</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">label</span><span class="p">,</span> <span class="nx">sourceTotalValue</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">subgroup</span><span class="p">,</span> <span class="nx">$groupRow</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">$row</span><span class="p">,</span> <span class="nx">$countLabel</span><span class="p">,</span> <span class="nx">$count</span><span class="p">,</span>
            <span class="nx">total</span> <span class="o">=</span> <span class="nx">sourceTotalValue</span><span class="p">;</span>

        <span class="nx">$row</span> <span class="o">=</span> <span class="nx">$groupRow</span>
            <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;alm-source&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;source-&quot;</span> <span class="o">+</span> <span class="nx">source</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">subgroup</span><span class="p">);</span>
        <span class="nx">$countLabel</span> <span class="o">=</span> <span class="nx">$row</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;alm-label &quot;</span> <span class="o">+</span> <span class="nx">group</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">events_url</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// if there is an events_url, we can link to it from the count</span>
            <span class="nx">$count</span> <span class="o">=</span> <span class="nx">$countLabel</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;alm-count&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;alm-count-&quot;</span> <span class="o">+</span> <span class="nx">source</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">group</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">source</span><span class="p">.</span><span class="nx">events_url</span><span class="p">;</span> <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// if no events_url, we just put in the count</span>
            <span class="nx">$count</span> <span class="o">=</span> <span class="nx">$countLabel</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;alm-count&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;alm-count-&quot;</span> <span class="o">+</span> <span class="nx">source</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">group</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">$count</span>
            <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">formatNumber_</span><span class="p">(</span><span class="nx">total</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;pkpTimedViews&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$countLabel</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">label</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// link the source name</span>
            <span class="nx">$countLabel</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span> <span class="nx">baseUrl_</span> <span class="o">+</span> <span class="s2">&quot;/sources/&quot;</span> <span class="o">+</span> <span class="nx">source</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">label</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Only add a chart if the browser supports SVG</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">hasSVG_</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">level</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

            <span class="c1">// check what levels we can show</span>
            <span class="kd">var</span> <span class="nx">showDaily</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">showMonthly</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">showYearly</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">by_year</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">level_data</span> <span class="o">=</span> <span class="nx">getData_</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="nx">source</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">yearTotal</span> <span class="o">=</span> <span class="nx">level_data</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">d</span><span class="p">[</span><span class="nx">subgroup</span><span class="p">];</span> <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">numYears</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">year</span><span class="p">.</span><span class="nx">utc</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">pub_date</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">length</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">yearTotal</span> <span class="o">&gt;=</span> <span class="nx">minItems_</span><span class="p">.</span><span class="nx">minEventsForYearly</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">numYears</span> <span class="o">&gt;=</span> <span class="nx">minItems_</span><span class="p">.</span><span class="nx">minYearsForYearly</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">showYearly</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="nx">level</span> <span class="o">=</span> <span class="s1">&#39;year&#39;</span><span class="p">;</span>
                <span class="p">};</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">by_month</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">level_data</span> <span class="o">=</span> <span class="nx">getData_</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="nx">source</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">monthTotal</span> <span class="o">=</span> <span class="nx">level_data</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">d</span><span class="p">[</span><span class="nx">subgroup</span><span class="p">];</span> <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">numMonths</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">month</span><span class="p">.</span><span class="nx">utc</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">pub_date</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">length</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">monthTotal</span> <span class="o">&gt;=</span> <span class="nx">minItems_</span><span class="p">.</span><span class="nx">minEventsForMonthly</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">numMonths</span> <span class="o">&gt;=</span> <span class="nx">minItems_</span><span class="p">.</span><span class="nx">minMonthsForMonthly</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">showMonthly</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="nx">level</span> <span class="o">=</span> <span class="s1">&#39;month&#39;</span><span class="p">;</span>
                <span class="p">};</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">by_day</span><span class="p">){</span>
                <span class="nx">level_data</span> <span class="o">=</span> <span class="nx">getData_</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="nx">source</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">dayTotal</span> <span class="o">=</span> <span class="nx">level_data</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">d</span><span class="p">[</span><span class="nx">subgroup</span><span class="p">];</span> <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">numDays</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">day</span><span class="p">.</span><span class="nx">utc</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">pub_date</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">length</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">dayTotal</span> <span class="o">&gt;=</span> <span class="nx">minItems_</span><span class="p">.</span><span class="nx">minEventsForDaily</span> <span class="o">&amp;&amp;</span> <span class="nx">numDays</span> <span class="o">&gt;=</span> <span class="nx">minItems_</span><span class="p">.</span><span class="nx">minDaysForDaily</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">showDaily</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="nx">level</span> <span class="o">=</span> <span class="s1">&#39;day&#39;</span><span class="p">;</span>
                <span class="p">};</span>
            <span class="p">}</span>

            <span class="c1">// The level and level_data should be set to the finest level</span>
            <span class="c1">// of granularity that we can show</span>
            <span class="nx">timeInterval</span> <span class="o">=</span> <span class="nx">getTimeInterval_</span><span class="p">(</span><span class="nx">level</span><span class="p">);</span>

            <span class="c1">// check there is data for</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">showDaily</span> <span class="o">||</span> <span class="nx">showMonthly</span> <span class="o">||</span> <span class="nx">showYearly</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">$row</span>
                    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;alm-source with-chart&#39;</span><span class="p">);</span>

                <span class="kd">var</span> <span class="nx">$chartDiv</span> <span class="o">=</span> <span class="nx">$row</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;alm-chart&quot;</span><span class="p">);</span>

                <span class="kd">var</span> <span class="nx">viz</span> <span class="o">=</span> <span class="nx">getViz_</span><span class="p">(</span><span class="nx">$chartDiv</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">subgroup</span><span class="p">);</span>
                <span class="nx">loadData_</span><span class="p">(</span><span class="nx">viz</span><span class="p">,</span> <span class="nx">level</span><span class="p">);</span>

                <span class="kd">var</span> <span class="nx">update_controls</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">control</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">control</span><span class="p">.</span><span class="nx">siblings</span><span class="p">(</span><span class="s1">&#39;.alm-control&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>
                    <span class="nx">control</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>
                <span class="p">};</span>

                <span class="kd">var</span> <span class="nx">$levelControlsDiv</span> <span class="o">=</span> <span class="nx">$chartDiv</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;alm-control-label&quot;</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="s2">&quot;width: &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">viz</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px;&quot;</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">showDaily</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">$levelControlsDiv</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span> <span class="s2">&quot;javascript:void(0)&quot;</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">classed</span><span class="p">(</span><span class="s2">&quot;alm-control&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">classed</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="o">!</span><span class="nx">showDaily</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">classed</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">level</span> <span class="o">==</span> <span class="s1">&#39;day&#39;</span><span class="p">))</span>
                        <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;daily (first 30)&quot;</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">showDaily</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">))</span> <span class="p">{</span>
                                <span class="nx">loadData_</span><span class="p">(</span><span class="nx">viz</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">);</span>
                                <span class="nx">update_controls</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">);</span>

                    <span class="nx">$levelControlsDiv</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot; | &quot;</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">showMonthly</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">$levelControlsDiv</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span> <span class="s2">&quot;javascript:void(0)&quot;</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">classed</span><span class="p">(</span><span class="s2">&quot;alm-control&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">classed</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="o">!</span><span class="nx">showMonthly</span> <span class="o">||</span> <span class="o">!</span><span class="nx">showYearly</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">classed</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">level</span> <span class="o">==</span> <span class="s1">&#39;month&#39;</span><span class="p">))</span>
                        <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;monthly&quot;</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">showMonthly</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">))</span> <span class="p">{</span>
                            <span class="nx">loadData_</span><span class="p">(</span><span class="nx">viz</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">);</span>
                            <span class="nx">update_controls</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
                        <span class="p">}</span> <span class="p">});</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">showYearly</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">$levelControlsDiv</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
                            <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot; | &quot;</span><span class="p">);</span>
                    <span class="p">}</span>

                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">showYearly</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">$levelControlsDiv</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span> <span class="s2">&quot;javascript:void(0)&quot;</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">classed</span><span class="p">(</span><span class="s2">&quot;alm-control&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">classed</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="o">!</span><span class="nx">showYearly</span> <span class="o">||</span> <span class="o">!</span><span class="nx">showMonthly</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">classed</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">level</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span><span class="p">))</span>
                        <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;yearly&quot;</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">showYearly</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">))</span> <span class="p">{</span>
                                <span class="nx">loadData_</span><span class="p">(</span><span class="nx">viz</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">);</span>
                                <span class="nx">update_controls</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">};</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="nx">$row</span><span class="p">;</span>
    <span class="p">};</span>


    <span class="cm">/**</span>
<span class="cm">     * Extract the date from the source</span>
<span class="cm">     * @param level (day|month|year)</span>
<span class="cm">     * @param d the datum</span>
<span class="cm">     * @return {Date}</span>
<span class="cm">     */</span>
    <span class="kd">var</span> <span class="nx">getDate_</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s1">&#39;year&#39;</span><span class="o">:</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">year</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="k">case</span> <span class="s1">&#39;month&#39;</span><span class="o">:</span>
                <span class="c1">// js Date indexes months at 0</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">year</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">month</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="k">case</span> <span class="s1">&#39;day&#39;</span><span class="o">:</span>
                <span class="c1">// js Date indexes months at 0</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">year</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">month</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">day</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>


    <span class="cm">/**</span>
<span class="cm">     * Format the date for display</span>
<span class="cm">     * @param level (day|month|year)</span>
<span class="cm">     * @param d the datum</span>
<span class="cm">     * @return {String}</span>
<span class="cm">     */</span>
    <span class="kd">var</span> <span class="nx">getFormattedDate_</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s1">&#39;year&#39;</span><span class="o">:</span>
                <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">)(</span><span class="nx">getDate_</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">d</span><span class="p">));</span>
            <span class="k">case</span> <span class="s1">&#39;month&#39;</span><span class="o">:</span>
                <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;%b %y&quot;</span><span class="p">)(</span><span class="nx">getDate_</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">d</span><span class="p">));</span>
            <span class="k">case</span> <span class="s1">&#39;day&#39;</span><span class="o">:</span>
                <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;%d %b %y&quot;</span><span class="p">)(</span><span class="nx">getDate_</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">d</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">};</span>


    <span class="cm">/**</span>
<span class="cm">     * Extract the data from the source.</span>
<span class="cm">     * @param {string} level (day|month|year)</span>
<span class="cm">     * @param {Object} source</span>
<span class="cm">     * @return {Array} Metrics</span>
<span class="cm">     */</span>
    <span class="kd">var</span> <span class="nx">getData_</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s1">&#39;year&#39;</span><span class="o">:</span>
                <span class="k">return</span> <span class="nx">source</span><span class="p">.</span><span class="nx">by_year</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;month&#39;</span><span class="o">:</span>
                <span class="k">return</span> <span class="nx">source</span><span class="p">.</span><span class="nx">by_month</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;day&#39;</span><span class="o">:</span>
                <span class="k">return</span> <span class="nx">source</span><span class="p">.</span><span class="nx">by_day</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Returns a d3 timeInterval for date operations.</span>
<span class="cm">     * @param {string} level (day|month|year</span>
<span class="cm">     * @return {Object} d3 time Interval</span>
<span class="cm">     */</span>
    <span class="kd">var</span> <span class="nx">getTimeInterval_</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s1">&#39;year&#39;</span><span class="o">:</span>
                <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">year</span><span class="p">.</span><span class="nx">utc</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;month&#39;</span><span class="o">:</span>
                <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">month</span><span class="p">.</span><span class="nx">utc</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;day&#39;</span><span class="o">:</span>
                <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">day</span><span class="p">.</span><span class="nx">utc</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * The basic general set up of the graph itself</span>
<span class="cm">     * @param {JQueryElement} chartDiv The div where the chart should go</span>
<span class="cm">     * @param {Object} source</span>
<span class="cm">     * @param {Array} group The group for 86 chart</span>
<span class="cm">     * @return {Object}</span>
<span class="cm">     */</span>
    <span class="kd">var</span> <span class="nx">getViz_</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chartDiv</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">subgroup</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">viz</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="c1">// size parameters</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">margin</span> <span class="o">=</span> <span class="p">{</span><span class="nx">top</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">right</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span> <span class="nx">bottom</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">left</span><span class="o">:</span> <span class="mi">50</span><span class="p">};</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="mi">700</span> <span class="o">-</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">right</span><span class="p">;</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">115</span> <span class="o">-</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">bottom</span><span class="p">;</span>

        <span class="c1">// div where everything goes</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">chartDiv</span> <span class="o">=</span> <span class="nx">chartDiv</span><span class="p">;</span>

        <span class="c1">// source data and which group</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">group</span> <span class="o">=</span> <span class="nx">group</span><span class="p">;</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">subgroup</span> <span class="o">=</span> <span class="nx">subgroup</span><span class="p">;</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="p">;</span>

        <span class="c1">// just for record keeping</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">group</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">subgroup</span><span class="p">;</span>

        <span class="nx">viz</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">scale</span><span class="p">();</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">x</span><span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">width</span><span class="p">]);</span>

        <span class="nx">viz</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">();</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">y</span><span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="nx">viz</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>

        <span class="nx">viz</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">ordinal</span><span class="p">();</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">z</span><span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="nx">group</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">group</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;-alt&#39;</span><span class="p">]);</span>

        <span class="c1">// the chart</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">svg</span> <span class="o">=</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">chartDiv</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">width</span> <span class="o">+</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">right</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">height</span> <span class="o">+</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="s2">&quot;translate(&quot;</span> <span class="o">+</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">);</span>


        <span class="c1">// draw the bars g first so it ends up underneath the axes</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">bars</span> <span class="o">=</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">);</span>

        <span class="c1">// and the shadow bars on top for the tooltips</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">barsForTooltips</span> <span class="o">=</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">);</span>

        <span class="nx">viz</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;x axis&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="s2">&quot;translate(0,&quot;</span> <span class="o">+</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">height</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">);</span>

        <span class="nx">viz</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;y axis&quot;</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">viz</span><span class="p">;</span>
    <span class="p">};</span>


    <span class="cm">/**</span>
<span class="cm">     * Takes in the basic set up of a graph and loads the data itself</span>
<span class="cm">     * @param {Object} viz AlmViz object</span>
<span class="cm">     * @param {string} level (day|month|year)</span>
<span class="cm">     */</span>
    <span class="kd">var</span> <span class="nx">loadData_</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">viz</span><span class="p">,</span> <span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">group</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">subgroup</span> <span class="o">=</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">subgroup</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">level_data</span> <span class="o">=</span> <span class="nx">getData_</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">source</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">timeInterval</span> <span class="o">=</span> <span class="nx">getTimeInterval_</span><span class="p">(</span><span class="nx">level</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">end_date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
        <span class="c1">// use only first 29 days if using day view</span>
        <span class="c1">// close out the year otherwise</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">level</span> <span class="o">==</span> <span class="s1">&#39;day&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">end_date</span> <span class="o">=</span> <span class="nx">timeInterval</span><span class="p">.</span><span class="nx">offset</span><span class="p">(</span><span class="nx">pub_date</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">end_date</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">year</span><span class="p">.</span><span class="nx">utc</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">end_date</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">//</span>
        <span class="c1">// Domains for x and y</span>
        <span class="c1">//</span>
        <span class="c1">// a time x axis, between pub_date and end_date</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">x</span><span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="nx">timeInterval</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">pub_date</span><span class="p">),</span> <span class="nx">end_date</span><span class="p">]);</span>

        <span class="c1">// a linear axis from 0 to max value found</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">y</span><span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">level_data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">[</span><span class="nx">subgroup</span><span class="p">];</span> <span class="p">})]);</span>

        <span class="c1">//</span>
        <span class="c1">// Axis</span>
        <span class="c1">//</span>
        <span class="c1">// a linear axis between publication date and current date</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">xAxis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">axis</span><span class="p">()</span>
            <span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="nx">viz</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">tickSize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">ticks</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

        <span class="c1">// a linear y axis between 0 and max value found in data</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">yAxis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">axis</span><span class="p">()</span>
            <span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="nx">viz</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">orient</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">tickSize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">tickValues</span><span class="p">([</span><span class="nx">d3</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">viz</span><span class="p">.</span><span class="nx">y</span><span class="p">.</span><span class="nx">domain</span><span class="p">())])</span>   <span class="c1">// only one tick at max</span>
            <span class="p">.</span><span class="nx">tickFormat</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;,d&quot;</span><span class="p">));</span>

        <span class="c1">//</span>
        <span class="c1">// The chart itself</span>
        <span class="c1">//</span>

        <span class="c1">// TODO: these transitions could use a little work</span>

        <span class="c1">// add more padding to wider bars</span>
        <span class="kd">var</span> <span class="nx">rawWidth</span> <span class="o">=</span> <span class="p">(</span><span class="nx">viz</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="p">(</span><span class="nx">timeInterval</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">pub_date</span><span class="p">,</span> <span class="nx">end_date</span><span class="p">).</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
        <span class="kd">var</span> <span class="nx">barWidth</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">rawWidth</span> <span class="o">-</span> <span class="nx">rawWidth</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">barsForTooltips</span> <span class="o">=</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">barsForTooltips</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.barsForTooltip&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">level_data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">getDate_</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">d</span><span class="p">);</span> <span class="p">});</span>

        <span class="nx">barsForTooltips</span>
            <span class="p">.</span><span class="nx">exit</span><span class="p">()</span>
            <span class="p">.</span><span class="nx">remove</span><span class="p">();</span>

        <span class="kd">var</span> <span class="nx">bars</span> <span class="o">=</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">bars</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.bar&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">level_data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">getDate_</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">d</span><span class="p">);</span> <span class="p">});</span>

        <span class="nx">bars</span>
            <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;bar &quot;</span> <span class="o">+</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">z</span><span class="p">((</span><span class="nx">level</span> <span class="o">==</span> <span class="s1">&#39;day&#39;</span> <span class="o">?</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">weekOfYear</span><span class="p">(</span><span class="nx">getDate_</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">d</span><span class="p">))</span> <span class="o">:</span> <span class="nx">d</span><span class="p">.</span><span class="nx">year</span><span class="p">));</span> <span class="p">})</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="nx">bars</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">getDate_</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">d</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="p">})</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nx">barWidth</span><span class="p">);</span>

        <span class="nx">bars</span><span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
            <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nx">barWidth</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">y</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="nx">subgroup</span><span class="p">]);</span> <span class="p">})</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">y</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="nx">subgroup</span><span class="p">]);</span> <span class="p">});</span>

        <span class="nx">bars</span>
            <span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">transition</span><span class="p">()</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="nx">bars</span>
            <span class="p">.</span><span class="nx">exit</span><span class="p">()</span>
            <span class="p">.</span><span class="nx">remove</span><span class="p">();</span>

        <span class="nx">viz</span><span class="p">.</span><span class="nx">svg</span>
            <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;.x.axis&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">viz</span><span class="p">.</span><span class="nx">xAxis</span><span class="p">);</span>

        <span class="nx">viz</span><span class="p">.</span><span class="nx">svg</span>
            <span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;.y.axis&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">viz</span><span class="p">.</span><span class="nx">yAxis</span><span class="p">);</span>

        <span class="nx">barsForTooltips</span>
            <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;barsForTooltip &quot;</span> <span class="o">+</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">z</span><span class="p">((</span><span class="nx">level</span> <span class="o">==</span> <span class="s1">&#39;day&#39;</span> <span class="o">?</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">weekOfYear</span><span class="p">(</span><span class="nx">getDate_</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">d</span><span class="p">))</span> <span class="o">:</span> <span class="nx">d</span><span class="p">.</span><span class="nx">year</span><span class="p">));</span> <span class="p">});</span>

        <span class="nx">barsForTooltips</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nx">barWidth</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">getDate_</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">d</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="p">})</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">y</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="nx">subgroup</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="p">})</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="nx">viz</span><span class="p">.</span><span class="nx">y</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="nx">subgroup</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="p">});</span>


        <span class="c1">// add in some tool tips</span>
        <span class="nx">viz</span><span class="p">.</span><span class="nx">barsForTooltips</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span>
                <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">tooltip</span><span class="p">(</span><span class="s1">&#39;destroy&#39;</span><span class="p">);</span> <span class="c1">// need to destroy so all bars get updated</span>
                <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">tooltip</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span> <span class="nx">formatNumber_</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="nx">subgroup</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; in &quot;</span> <span class="o">+</span> <span class="nx">getFormattedDate_</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">d</span><span class="p">),</span> <span class="nx">container</span><span class="o">:</span> <span class="s2">&quot;body&quot;</span><span class="p">});</span>
            <span class="p">}</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// example 2</span>
<span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">baseUrl</span><span class="o">:</span> <span class="s1">&#39;http://alm.plos.org&#39;</span><span class="p">,</span>
    <span class="nx">minItemsToShowGraph</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">minEventsForYearly</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="nx">minEventsForMonthly</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="nx">minEventsForDaily</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="nx">minYearsForYearly</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">minMonthsForMonthly</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">minDaysForDaily</span><span class="o">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="nx">vizDiv</span><span class="o">:</span> <span class="s2">&quot;div#example2&quot;</span><span class="p">,</span>
    <span class="nx">showTitle</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">groups</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;viewed&quot;</span><span class="p">,</span> <span class="nx">display_name</span><span class="o">:</span> <span class="s2">&quot;Viewed&quot;</span><span class="p">,</span> <span class="nx">sources</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;counter&quot;</span><span class="p">]</span> <span class="p">}]</span>
  <span class="p">};</span>

<span class="kd">var</span> <span class="nx">doi</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;p#example2&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-doi&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">api_key</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;p#example2&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-api_key&#39;</span><span class="p">);</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nb">encodeURI</span><span class="p">(</span><span class="s2">&quot;http://alm.plos.org/api/v5/articles?api_key=&quot;</span> <span class="o">+</span> <span class="nx">api_key</span> <span class="o">+</span> <span class="s2">&quot;&amp;ids=&quot;</span> <span class="o">+</span> <span class="nx">doi</span> <span class="o">+</span> <span class="s2">&quot;&amp;info=history&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="nx">options</span><span class="p">[</span><span class="s1">&#39;almStatsJson&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">json</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">almviz</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AlmViz</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="nx">almviz</span><span class="p">.</span><span class="nx">initViz</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div>

  <h3>Tags</h3>
  <ul class="tag_box inline">
    <li><span class="glyphicon glyphicon-tags"></span></li>
    
    
  
    <li><a href="/tags/">d3.js <span>4</span></a></li>
  
    <li><a href="/tags/">counter <span>2</span></a></li>
  



  </ul>


            <!-- COinS metadata (for citation managers like Zotero etc), goes in body text -->
<span
  class="Z3988"
  title="ctx_ver=Z39.88-2004
  &amp;rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Adc
  &amp;rfr_id=info%3Asid%2Focoins.info%3Agenerator
  &amp;rft.title=HTML views and PDF downloads over time
  &amp;rft.creator=
  &amp;rft.date=2014-02-23
  &amp;rft.language=EN
  &amp;rft.rights=CC0
  &amp;rft_id=http://articlemetrics.github.io/examples/2014/02/23/html-views-and-pdf-downloads-over-time/">
</span>

            
              <hr>
              <div id="disqus_thread"></div>
<script type="text/javascript">
    
    var disqus_shortname = 'articlemetrics'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
            
            <hr>
            <footer class="footer" role="contentinfo">
  <iframe src="http://ghbtns.com/github-btn.html?user=articlemetrics&repo=alm&type=watch&count=true"
  allowtransparency="true" frameborder="0" scrolling="0" width="100" height="20"></iframe>

  <iframe class="github-btn" src="http://ghbtns.com/github-btn.html?user=articlemetrics&repo=alm&type=fork&count=true"
  allowtransparency="true" frameborder="0" scrolling="0" width="100" height="20"></iframe>

  <iframe src="http://ghbtns.com/github-btn.html?user=articlemetrics&type=follow&count=true"
  allowtransparency="true" frameborder="0" scrolling="0" width="180" height="20"></iframe>

  <p>Maintained by the core team with the help of our <a href="/docs/Contributors">contributors</a>.<br/>
  Source code for <a href="https://github.com/articlemetrics/alm">ALM application</a> and <a href="https://github.com/articlemetrics/articlemetrics.github.io">this website</a> available on Github. <br/> Code licensed under <a href="https://github.com/articlemetrics/alm/blob/master/LICENSE.md">Apache 2.0</a>, documentation under <a href="http://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a>.</p>
</div>
          </div>
        </div>


      </div>
    </div> <!-- /container -->

    <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', '']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </body>
</html>