<!DOCTYPE html>
<html lang="en">
    <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Installation</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="Martin Fenner" />

    <!-- RDFa Metadata (in DublinCore) -->
    <meta property="dc:title" content="Installation" />
    <meta property="dc:creator" content="" />
    <meta name="citation_publication_date" content=""/>
    <meta property="dc:format" content="text/html" />
    <meta property="dc:language" content="en" />
    <meta property="dc:identifier" content="/docs/Installation/" />
    <meta property="dc:rights" content="CC-BY" />
    <meta property="dc:source" content="Article-Level Metrics" />
    <meta property="dc:subject" content="Scholarly Communication" />
    <meta property="dc:type" content="website" />

    <!-- Google Scholar Metadata -->
    <meta name="citation_author" content=""/>
    <meta name="citation_publication_date" content=""/>
    <meta name="citation_title" content="Installation"/>
    <meta name="citation_journal_title" content="Article-Level Metrics"/>

    <link rel="alternate" type="application/rss+xml" title="Article-Level Metrics" href="/rss.xml" />
    <link rel="alternate" type="application/atom+xml" title="Article-Level Metrics" href="/atom.xml" />

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,400italic,600italic' rel='stylesheet' type='text/css'>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/bootstrap-theme.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/github.css">

    <!-- Javascript -->
    <script src="/js/d3.v3.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">ALM</a>
    </div>
    <div class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li><a href="/about">About</a></li>
        <li><a href="/blog">Blog</a></li>
        <li><a href="/examples">Examples</a></li>
        <li><a href="/status">Status</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="/docs/Home">Home</a></li>
            <li><a href="/docs/Installation">Installation</a></li>
            <li><a href="/docs/Setup">Setup</a></li>
            <li><a href="/docs/Sources">Sources</a></li>
            <li><a href="/docs/API">API</a></li>
            <li><a href="/docs/Rake">Rake</a></li>
            <li><a href="/docs/Alerts">Alerts</a></li>
            <li><a href="/docs/FAQ">FAQ</a></li>
            <li><a href="/docs/Roadmap">Roadmap</a></li>
            <li><a href="/docs/Contributors">Contributors</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>
    <div class="container">
      <div class="page-header">
        <h1>Installation</h1>
        <p class="subtitle">
        </p>
      </div>

      <div class="content">
        <div class="row">
          <div class="col-md-9">
            
            <p>ALM is a typical Ruby on Rails web application with one unusual feature: it requires the CouchDB database. CouchDB is used to store the responses from external API calls, MySQL is used for everything else (or PostgreSQL, see below). The application has been tested with Apache/Passenger, but should also run in other deployment environments, e.g. Nginx/Unicorn or WEBrick. ALM uses Ruby on Rails 3.2.x. The application has extensive test coverage using <a href="http://rspec.info/">Rspec</a> and <a href="http://cukes.info/">Cucumber</a>.</p>

<h4 id="toc_0">Ruby 1.9</h4>

<p>ALM requires Ruby 1.9.3. Not all Linux distributions include Ruby 1.9 as a standard install, which makes it more difficult than it should be. <a href="http://rvm.io/">RVM</a> and <a href="https://github.com/sstephenson/rbenv">Rbenv</a> are Ruby version management tools for installing Ruby 1.9. Unfortunately they also introduce additional dependencies, making them sometimes not the best choices in a production environment. The ALM application has not been tested with Ruby 2.0, but migration to Ruby 2.0 is planned in 2014.</p>

<h4 id="toc_1">Installation Options</h4>

<p>There are many installation options, but the following two should cover most scenarios:</p>

<ul>
<li>on a development machine: installation in a virtual machine via Vagrant is strongly recommended</li>
<li>on a server: installation in a virtual machine via Vagrant or manual installation is recommended, with code updates via Capistrano</li>
</ul>

<p>Hosting the ALM application at a Platform as a Service (PaaS) provider such as Heroku or OpenShift is possible, but has not been tested.</p>

<h2 id="toc_2">Automatic Installation using Vagrant</h2>

<p>This is the preferred way to install the ALM application on a development machine. The application will automatically be installed in a self-contained virtual machine, using <a href="https://www.virtualbox.org/wiki/Downloads">Virtualbox</a>, <a href="http://downloads.vagrantup.com/">Vagrant</a> and <a href="http://docs.opscode.com/chef_solo.html">Chef Solo</a>. Download and install <a href="https://www.virtualbox.org/wiki/Downloads">Virtualbox</a>, <a href="http://downloads.vagrantup.com/">Vagrant</a> and the <a href="https://github.com/schisamo/vagrant-omnibus">Omnibus</a> Vagrant plugin (which installs the newest version of Chef Solo). You can also use <a href="https://www.vagrantup.com/vmware">VMware Fusion or Workstation</a> instead of <a href="https://www.virtualbox.org/wiki/Downloads">Virtualbox</a>, but the VMware Vagrant plugin requires a commercial license.</p>

<h3 id="toc_3">Custom settings (passwords, API keys)</h3>

<p>This is an optional step. Rename the file <code>config.json.example</code> to <code>config.json</code> and add your custom settings to it, including usernames, passwords, API keys and the MySQL password. This will automatically configure the application with your settings.</p>

<p>Then install the application with:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">git clone git://github.com/articlemetrics/alm.git
<span class="nb">cd </span>alm
vagrant up
</code></pre></div>
<p>This installs the ALM server on a Ubuntu 12.04 virtual machine. After installation is finished (this can take up to 15 min on the first run) you can access the ALM application with your web browser at</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">http://localhost:8080
</code></pre></div>
<p>or</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">http://33.33.33.44
</code></pre></div>
<p>The username and password for the web interface are <code>articlemetrics</code>. The code for the ALM application is in a shared folder and can be reached both from the host and virtual machine. To get to the application root directory in the virtual machine, do</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">vagrant ssh
<span class="nb">cd</span> /vagrant
</code></pre></div>
<p>The <code>vagrant</code> user on the virtual machine has the password <code>vagrant</code>, and has sudo privileges. The Rails application runs in Development mode. The MySQL password is stored at <code>config/database.yml</code>, and is auto-generated during the installation. CouchDB is set up to run in <strong>Admin Party</strong> mode, i.e. without usernames or passwords. The database servers can be reached from the virtual machine or via port forwarding.</p>

<h2 id="toc_4">Automatic Installation on AWS using Vagrant</h2>

<p>This is the preferred way to install the ALM application on Amazon Web Services (AWS). machine. Download and install  <a href="http://downloads.vagrantup.com/">Vagrant</a>. Install the vagrant-aws plugin:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">vagrant plugin install vagrant-aws
</code></pre></div>
<p>So that we can use any Amazon Machine Image (<a href="https://aws.amazon.com/amis">AMI</a>) - the ALM application has been tested with Ubuntu 12.04 - we want to install the <a href="https://github.com/schisamo/vagrant-omnibus">vagrant-omnibus</a> plugin that adds Chef solo to any VM:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">vagrant plugin install vagrant-omnibus
</code></pre></div>
<p>Install a dummy AWS box and name it <code>opscode-ubuntu-12.04</code>:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">vagrant box add opscode-ubuntu-12.04 https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box
</code></pre></div>
<p>Add your AWS settings (access_key, secret_access_key, private_key_path, keypair_name, security_groups) to Vagrantfile. We recommend to use at least a small EC2 instance, the ami <code>ami-e7582d8e</code> contains Ubuntu 12.04. We also install the latest Chef version using omnibus.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="n">config</span><span class="o">.</span><span class="n">omnibus</span><span class="o">.</span><span class="n">chef_version</span> <span class="o">=</span> <span class="ss">:latest</span>

<span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;alm&quot;</span>

<span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:aws</span> <span class="k">do</span> <span class="o">|</span><span class="n">aws</span><span class="p">,</span> <span class="n">override</span><span class="o">|</span>
  <span class="n">aws</span><span class="o">.</span><span class="n">access_key_id</span> <span class="o">=</span> <span class="s2">&quot;EXAMPLE&quot;</span>
  <span class="n">aws</span><span class="o">.</span><span class="n">secret_access_key</span> <span class="o">=</span> <span class="s2">&quot;EXAMPLE&quot;</span>
  <span class="n">aws</span><span class="o">.</span><span class="n">keypair_name</span> <span class="o">=</span> <span class="s2">&quot;EXAMPLE&quot;</span>
  <span class="n">aws</span><span class="o">.</span><span class="n">security_groups</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;EXAMPLE&quot;</span><span class="o">]</span>
  <span class="n">aws</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="s1">&#39;m1.small&#39;</span>
  <span class="n">aws</span><span class="o">.</span><span class="n">ami</span> <span class="o">=</span> <span class="s2">&quot;ami-e7582d8e&quot;</span>
  <span class="n">aws</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">Name</span><span class="p">:</span> <span class="s1">&#39;Vagrant alm&#39;</span> <span class="p">}</span>

  <span class="n">override</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;ubuntu&quot;</span>
  <span class="n">override</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">private_key_path</span> <span class="o">=</span> <span class="s2">&quot;/EXAMPLE.pem&quot;</span>
<span class="k">end</span>
</code></pre></div>
<h4 id="toc_5">Custom settings (passwords, API keys)</h4>

<p>This is an optional step. Rename the file <code>config.json.example</code> to <code>config.json</code> and add your custom settings to it, including usernames, passwords, API keys and the MySQL password. This will automatically configure the application with your settings.</p>

<p>Then install the application with:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">git clone git://github.com/articlemetrics/alm.git
<span class="nb">cd </span>alm
vagrant up --provider aws
</code></pre></div>
<p>After installation is finished (this can take up to 15 min on the first run) you can access the ALM application with your web browser at the web address of your EC2 instance (the use of Elastic IPs and a DNS server is recommended).</p>

<p>After installation you first have to create a default user using the <code>Sign Up</code> button. The code for the ALM application is in the <code>/vagrant</code> folder and is rsynced from the host. To get to the application root directory in the virtual machine, do (using the <code>private_key_path</code> and <code>host_name</code>):</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">vagrant ssh
<span class="nb">cd</span> /vagrant
</code></pre></div>
<p>The Rails application runs in Production mode. The MySQL password is stored at <code>config/database.yml</code>, CouchDB is set up to run in <strong>Admin Party</strong> mode, i.e. without usernames or passwords. The database servers can be reached from the virtual machine or via port forwarding.</p>

<p>The ALM application can also be installed with <a href="https://www.digitalocean.com">DigitalOcean</a> or <a href="http://www.rackspace.com">Rackspace</a> using Vagrant and the respective plugins (<a href="https://github.com/smdahlen/vagrant-digitalocean">vagrant-digitalocean</a> and <a href="https://github.com/mitchellh/vagrant-rackspace">vagrant-rackspace</a>) in a process similar to the AWS installation. The settings for DigitalOcean are as follows:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:digital_ocean</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="p">,</span> <span class="n">override</span><span class="o">|</span>
  <span class="n">override</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">private_key_path</span> <span class="o">=</span> <span class="s1">&#39;~/.ssh/id_rsa&#39;</span>
  <span class="n">override</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s1">&#39;digital_ocean&#39;</span>
  <span class="n">override</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/smdahlen/vagrant-digitalocean/raw/master/box/digital_ocean.box&quot;</span>
  <span class="n">override</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;ubuntu&quot;</span>

  <span class="n">provider</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="s1">&#39;EXAMPLE&#39;</span>
  <span class="n">provider</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="s1">&#39;EXAMPLE&#39;</span>
  <span class="n">provider</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;1GB&#39;</span>
<span class="k">end</span>
</code></pre></div>
<h2 id="toc_6">Manual installation</h2>

<p>These instructions assume a fresh installation of Ubuntu 12.04. Installation on other Unix/Linux platforms should be similar, but may require additional steps to install Ruby 1.9. The instructions assume a user with sudo privileges, and this can also be a new user created just for running the ALM application.</p>

<h4 id="toc_7">Update package lists</h4>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo apt-get update
</code></pre></div>
<h4 id="toc_8">Install required packages</h4>

<p><code>libxml2-dev</code> and <code>libxslt1-dev</code> are required for XML processing by the <code>nokogiri</code> gem, <code>nodejs</code> provides Javascript for the <code>therubyracer</code> gem.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo apt-get install curl build-essential git-core libxml2-dev libxslt1-dev nodejs
</code></pre></div>
<h4 id="toc_9">Install Ruby 1.9.3</h4>

<p>We only need one Ruby version and manage gems with bundler, so there is no need to install <code>rvm</code> or <code>rbenv</code>.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo apt-get install ruby1.9.3
</code></pre></div>
<h4 id="toc_10">Install databases</h4>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo apt-get install couchdb mysql-server
</code></pre></div>
<h4 id="toc_11">Install Memcached</h4>

<p>Memcached is used to cache requests (in particular API requests) in production, and the default configuration can be used. If you want to run memcached on a different host, change <code>config.cache_store = :dalli_store, { :namespace =&gt; &quot;alm&quot; }</code> in <code>config/environments/production.rb</code> to <code>config.cache_store = :dalli_store, &#39;cache.example.com&#39;, { :namespace =&gt; &quot;alm&quot; }</code>.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo apt-get install memcached
</code></pre></div>
<h4 id="toc_12">Install Postfix</h4>

<p>Postfix is used to send reports via email. Alternatively, a different SMTP host can be configured in <code>config/settings.yml</code>.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo apt-get install postfix
</code></pre></div>
<p>The default configuration assumes <code>address: localhost</code>, <code>port: 25</code>. You can configure mail in <code>config/settings.yml</code>:</p>
<div class="highlight"><pre><code class="yaml language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">mail</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">address</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">domain</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">user_name</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">authentication</span><span class="p-Indicator">:</span>
</code></pre></div>
<p>More information can be found <a href="http://guides.rubyonrails.org/action_mailer_basics.html">here</a>.</p>

<h4 id="toc_13">Install Apache and dependencies required for Passenger</h4>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo apt-get install apache2 apache2-prefork-dev libapr1-dev libaprutil1-dev libcurl4-openssl-dev
</code></pre></div>
<h4 id="toc_14">Install and configure Passenger</h4>

<p>Passenger is a Rails application server: <a href="http://www.modrails.com">http://www.modrails.com</a>. Update <code>passenger.load</code> and <code>passenger.conf</code> when you install a new version of the passenger gem.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo gem install passenger -v 3.0.19
sudo passenger-install-apache2-module --auto

<span class="c"># /etc/apache2/mods-available/passenger.load</span>
LoadModule passenger_module /var/lib/gems/1.9.1/gems/passenger-3.0.19/ext/apache2/mod_passenger.so

<span class="c"># /etc/apache2/mods-available/passenger.conf</span>
PassengerRoot /var/lib/gems/1.9.1/gems/passenger-3.0.19
PassengerRuby /usr/bin/ruby1.9.1

sudo a2enmod passenger
</code></pre></div>
<h4 id="toc_15">Set up virtual host</h4>

<p>Please set <code>ServerName</code> if you have set up more than one virtual host. Also don&#39;t forget to add<code>AllowEncodedSlashes On</code> to the Apache virtual host file in order to keep Apache from messing up encoded embedded slashes in DOIs. Use <code>RailsEnv production</code> to use the Rails production environment (and use <code>rake db:setup RAILS_ENV=production</code> when you set up the MySQL databases).</p>
<div class="highlight"><pre><code class="apache language-apache" data-lang="apache"><span class="c"># /etc/apache2/sites-available/alm</span>
<span class="nt">&lt;VirtualHost</span> <span class="s">*:80</span><span class="nt">&gt;</span>
  <span class="nb">ServerName</span> localhost
  <span class="nb">RailsEnv</span> development
  <span class="nb">DocumentRoot</span> <span class="sx">/var/www/alm/public</span>

  <span class="nt">&lt;Directory</span> <span class="s">/var/www/alm/public</span><span class="nt">&gt;</span>
    <span class="nb">Options</span> FollowSymLinks
    <span class="nb">AllowOverride</span> <span class="k">None</span>
    <span class="nb">Order</span> allow,deny
    <span class="nb">Allow</span> from <span class="k">all</span>
  <span class="nt">&lt;/Directory&gt;</span>

  <span class="c"># Important for ALM: keeps Apache from messing up encoded embedded slashes in DOIs</span>
  <span class="nb">AllowEncodedSlashes</span> <span class="k">On</span>

<span class="nt">&lt;/VirtualHost&gt;</span>
</code></pre></div>
<h4 id="toc_16">Install ALM code</h4>

<p>You may have to set the permissions first, depending on your server setup. Passenger by default is run by the user who owns <code>config.ru</code>.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">git clone git://github.com/articlemetrics/alm.git /var/www/alm
</code></pre></div>
<h4 id="toc_17">Install Bundler and Ruby gems required by the application</h4>

<p>Bundler is a tool to manage dependencies of Ruby applications: <a href="http://gembundler.com">http://gembundler.com</a>. We have to install <code>therubyracer</code> gem as sudo because of a permission problem (make sure the version matches the version in <code>Gemfile</code> in the ALM root directory).</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo gem install bundler
sudo gem install therubyracer -v <span class="s1">&#39;0.12.0&#39;</span>

<span class="nb">cd</span> /var/www/alm
bundle install
</code></pre></div>
<h4 id="toc_18">Set ALM configuration settings</h4>

<p>You want to set the MySQL username/password in <code>database.yml</code>, using either the root password that you generated when you installed MySQL, or a different MySQL user. You also want to set the site and session keys in <code>settings.yml</code>, they can be generated with <code>rake secret</code>.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nb">cd</span> /var/www/alm
cp config/database.yml.example config/database.yml
cp config/settings.yml.example config/settings.yml
</code></pre></div>
<h4 id="toc_19">Install ALM databases</h4>

<p>We just setup an empty database for CouchDB. With MySQL we also include all data to get started, including sample articles and a default user account (username/password <em>articlemetrics</em>). Use <code>RAILS_ENV=production</code> if you set up Passenger to run in the production environment.</p>

<p>It is possible to connect the ALM app to MySQL and/or CouchDB running on a different server, please change <code>host</code> in database.yml and <code>couched_url</code> in settings.yml accordingly.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nb">cd</span> /var/www/alm
rake db:setup <span class="nv">RAILS_ENV</span><span class="o">=</span>development
curl -X PUT http://localhost:5984/alm/
</code></pre></div>
<h4 id="toc_20">Start Apache</h4>

<p>We are making <code>alm</code> the default site.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo a2dissite default
sudo a2ensite alm
sudo service apache2 reload
</code></pre></div>
<p>You can now access the ALM application with your web browser at the name or IP address (if it is the only virtual host) of your Ubuntu installation.</p>

<h2 id="toc_21">Remote Installation via Capistrano</h2>

<p>This is the recommended strategy for production servers that use <a href="http://capistranorb.com">Capistrano</a>, a deployment automation tool. Capistrano takes care of code updates via git, database migrations and server restarts, but you still have to do the initial server setup of Ruby, MySQL, CouchDB, Apache and Passenger. And Capistrano requires a second local ALM installation, done either via Vagrant or manually (see above).</p>

<h4 id="toc_22">Install Ruby, MySQL, CouchDB, Apache and Passenger</h4>

<p>Unless you already have installed Ruby, MySQL, CouchDB, Apache and Passenger, please follow the steps for manual installation until <em>Install and configure Passenger</em>. We again assume Ubuntu 12.04.</p>

<h4 id="toc_23">Set up virtual host</h4>

<p>You probably have to provide a <code>ServerName</code>, we need to change <code>RailsEnv</code> to <code>production</code> and <code>DocumentRoot</code> to <code>/var/www/alm/current/public</code>.</p>
<div class="highlight"><pre><code class="apache language-apache" data-lang="apache"><span class="c"># /etc/apache2/sites-available/alm</span>
<span class="nt">&lt;VirtualHost</span> <span class="s">*:80</span><span class="nt">&gt;</span>
  <span class="nb">ServerName</span> EXAMPLE.ORG
  <span class="nb">RailsEnv</span> development
  <span class="nb">DocumentRoot</span> <span class="sx">/var/www/alm/current/public</span>

  <span class="nt">&lt;Directory</span> <span class="s">/var/www/alm/current/public</span><span class="nt">&gt;</span>
    <span class="nb">Options</span> FollowSymLinks
    <span class="nb">AllowOverride</span> <span class="k">None</span>
    <span class="nb">Order</span> allow,deny
    <span class="nb">Allow</span> from <span class="k">all</span>
  <span class="nt">&lt;/Directory&gt;</span>

  <span class="c"># Important for ALM: keeps Apache from messing up encoded embedded slashes in DOIs</span>
  <span class="nb">AllowEncodedSlashes</span> <span class="k">On</span>

<span class="nt">&lt;/VirtualHost&gt;</span>
</code></pre></div>
<h4 id="toc_24">Install Bundler</h4>

<p>Bundler is a tool to manage dependencies of Ruby applications: <a href="http://gembundler.com">http://gembundler.com</a>. We have to install <code>therubyracer</code> gem as sudo because of a permission problem (make sure the version matches the version in <code>Gemfile</code> in the ALM root directory).</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo gem install bundler
sudo gem install therubyracer -v <span class="s1">&#39;0.11.3&#39;</span>
</code></pre></div>
<h4 id="toc_25">Create CouchDB database</h4>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">curl -X PUT http://localhost:5984/alm/
</code></pre></div>
<h4 id="toc_26">Install Capistrano</h4>

<p>The next steps are done on the local development machine.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo gem install capistrano
<span class="nb">cd</span> /var/www/alm
capify .
</code></pre></div>
<h4 id="toc_27">Edit deployment configuration</h4>

<p>Edit the deployment configuration file that was just created by Capistrano. Add the name or IP address of your production server as <code>server</code>, and pick a <code>:user</code> and <code>:group</code> from the production server. We can either set <code>:password</code> or use SSH keys.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># /var/www/alm/config/deploy.rb</span>
<span class="nb">require</span> <span class="s2">&quot;bundler/capistrano&quot;</span>
<span class="nb">load</span> <span class="s1">&#39;deploy/assets&#39;</span>

<span class="n">server</span> <span class="s2">&quot;EXAMPLE.ORG&quot;</span><span class="p">,</span> <span class="ss">:app</span><span class="p">,</span> <span class="ss">:web</span><span class="p">,</span> <span class="ss">:db</span><span class="p">,</span> <span class="ss">:primary</span> <span class="o">=&gt;</span> <span class="kp">true</span>

<span class="n">set</span> <span class="ss">:application</span><span class="p">,</span> <span class="s2">&quot;alm&quot;</span>
<span class="n">set</span> <span class="ss">:user</span><span class="p">,</span> <span class="s2">&quot;deploy&quot;</span>
<span class="n">set</span> <span class="ss">:group</span><span class="p">,</span> <span class="s2">&quot;deploy&quot;</span>
<span class="n">set</span> <span class="ss">:password</span><span class="p">,</span> <span class="s2">&quot;EXAMPLE&quot;</span>
<span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s2">&quot;/var/www/</span><span class="si">#{</span><span class="n">application</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">set</span> <span class="ss">:deploy_via</span><span class="p">,</span> <span class="ss">:remote_cache</span>

<span class="n">set</span> <span class="ss">:scm</span><span class="p">,</span> <span class="s2">&quot;git&quot;</span>
<span class="n">set</span> <span class="ss">:repository</span><span class="p">,</span> <span class="s2">&quot;git://github.com/articlemetrics/alm.git&quot;</span>
<span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span>

<span class="n">set</span> <span class="ss">:bundle_without</span><span class="p">,</span> <span class="o">[</span><span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span><span class="o">]</span>

<span class="n">set</span> <span class="ss">:ruby_vm_type</span><span class="p">,</span>      <span class="ss">:mri</span>        <span class="c1"># :ree, :mri</span>
<span class="n">set</span> <span class="ss">:web_server_type</span><span class="p">,</span>   <span class="ss">:apache</span>     <span class="c1"># :apache, :nginx</span>
<span class="n">set</span> <span class="ss">:app_server_type</span><span class="p">,</span>   <span class="ss">:passenger</span>  <span class="c1"># :passenger, :mongrel</span>
<span class="n">set</span> <span class="ss">:db_server_type</span><span class="p">,</span>    <span class="ss">:mysql</span>      <span class="c1"># :mysql, :postgresql, :sqlite</span>

<span class="n">set</span> <span class="ss">:keep_releases</span><span class="p">,</span> <span class="mi">5</span>

<span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
  <span class="n">task</span> <span class="ss">:start</span> <span class="k">do</span> <span class="p">;</span> <span class="k">end</span>
  <span class="n">task</span> <span class="ss">:stop</span> <span class="k">do</span> <span class="p">;</span> <span class="k">end</span>
  <span class="n">task</span> <span class="ss">:restart</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">run</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">try_sudo</span><span class="si">}</span><span class="s2"> touch </span><span class="si">#{</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_path</span><span class="p">,</span><span class="s1">&#39;tmp&#39;</span><span class="p">,</span><span class="s1">&#39;restart.txt&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">before</span> <span class="s2">&quot;deploy:assets:precompile&quot;</span> <span class="k">do</span>
  <span class="n">run</span> <span class="o">[</span><span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/settings.yml </span><span class="si">#{</span><span class="n">release_path</span><span class="si">}</span><span class="s2">/config/settings.yml&quot;</span><span class="p">,</span>
   <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/database.yml </span><span class="si">#{</span><span class="n">release_path</span><span class="si">}</span><span class="s2">/config/database.yml&quot;</span><span class="p">,</span>
   <span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot; &amp;&amp; &quot;</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<h4 id="toc_28">Setup remote server</h4>

<p>This will create the required directories (<code>/var/www/alm/current</code>, <code>/var/www/alm/releases</code> and <code>/var/www/alm/shared</code>) on the production server (it is safe to run this command if one of the directories already exists). <code>deploy:update</code> will fetch the application via git. <code>rake db:setup</code> will not create user accounts or sample articles in the production environment.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nb">cd</span> /var/www/alm
cap deploy:setup
cap deploy:update
</code></pre></div>
<h4 id="toc_29">Set ALM configuration settings</h4>

<p>Back to the production server, finish the setup.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nb">cd</span> /var/www/alm/current
cp config/database.yml.example /var/www/alm/shared/database.yml
cp config/settings.yml.example /var/www/alm/shared/config/settings.yml
rake db:setup <span class="nv">RAILS_ENV</span><span class="o">=</span>production
sudo a2dissite default
sudo a2ensite alm
</code></pre></div>
<h3 id="toc_30">Start the remote ALM server</h3>

<p>You can now start the production server from your development machine.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">cap deploy:start
</code></pre></div>
<h4 id="toc_31">Update your application</h4>

<p>Deploy the application with the current code from Github without or with database migrations. You can rollback to the last deployed version if there is a problem.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">cap deploy
cap deploy:migrations
cap deploy:rollback
</code></pre></div>
<h3 id="toc_32">Precompile assets</h3>

<p>Assets (CSS, Javascripts, images) need to be precompiled when running Rails in the <code>production</code> environment (but not in <code>development</code>). Run the following rake task, then restart the server:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">bundle <span class="nb">exec </span>rake assets:precompile <span class="nv">RAILS_ENV</span><span class="o">=</span>production
</code></pre></div>
<h2 id="toc_33">Using PostgreSQL instead of MySQL</h2>

<p>The instructions above are for using MySQL, but the ALM application can also be installed with PostgreSQL with two small changes:</p>

<h3 id="toc_34">Install PostgreSQL gem</h3>

<p>Uncomment <code>gem &#39;pg&#39;</code> in your <code>Gemfile</code>, comment out <code>gem &#39;mysql2&#39;</code> and run <code>bundle update</code>:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.16&#39;</span>
<span class="c1">#gem &#39;mysql2&#39;, &#39;0.3.13&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 0.17.1&#39;</span>
</code></pre></div>
<h3 id="toc_35">Change database adapter</h3>

<p>Change the adapter in <code>config/database.yml</code> to use PostgreSQL instead of MySQL:</p>
<div class="highlight"><pre><code class="yaml language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">production</span><span class="p-Indicator">:</span>
  <span class="c1">#adapter:   mysql2</span>
  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span>   <span class="l-Scalar-Plain">postgresql</span>
  <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">alm_production</span>
  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">postgres</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">YOUR_PASSWORD</span>
  <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span>      <span class="l-Scalar-Plain">localhost</span>
  <span class="l-Scalar-Plain">pool</span><span class="p-Indicator">:</span>      <span class="l-Scalar-Plain">10</span>
</code></pre></div>
            <hr>
            <!-- COinS metadata (for citation managers like Zotero etc), goes in body text -->
<span
  class="Z3988"
  title="ctx_ver=Z39.88-2004
  &amp;rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Adc
  &amp;rfr_id=info%3Asid%2Focoins.info%3Agenerator
  &amp;rft.title=Installation
  &amp;rft.creator=
  &amp;rft.date=
  &amp;rft.language=EN
  &amp;rft.rights=CC0
  &amp;rft_id=http://articlemetrics.github.io/docs/Installation/">
</span>

            <div id="disqus_thread"></div>
<script type="text/javascript">
    
    var disqus_shortname = 'articlemetrics'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
        </div>


      </div>
    </div> <!-- /container -->

    <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', '']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </body>
</html>