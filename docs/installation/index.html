<h2 id="toc_0">Introduction</h2>

<p>Configuring Lagotto consists of three steps:</p>

<ul>
<li>Installation (this document)</li>
<li><a href="/docs/deployment">Deployment</a> if you are using Lagotto in a production system</li>
<li><a href="/docs/setup">Setup</a></li>
</ul>

<p>Lagotto is a typical Ruby on Rails web application, using MySQL (or PostgreSQL, see below), Memcached, Redis, Nginx, and Passenger.CouchDB is used to store the data from some external sources, but is not reqquired. Lagotto uses Ruby 2.x and Ruby on Rails 4.x. The application has extensive test coverage using <a href="http://rspec.info/">Rspec</a>.</p>

<p>Lagotto is Open Source software licensed with a <a href="https://github.com/lagotto/lagotto/blob/master/LICENSE.md">MIT License</a>, all dependencies (software and libraries) are also Open Source. Because of the background workers that talk to external APIs we recommend at least 1 Gb of RAM, and more if you have a large number of works.</p>

<h4 id="toc_1">Ruby</h4>

<p>Lagotto requires Ruby 2.x. <a href="http://rvm.io/">RVM</a> and <a href="https://github.com/sstephenson/rbenv">Rbenv</a> are Ruby version management tools for installing Ruby, unfortunately they also introduce additional dependencies, making them not the best choices in a production environment. The Chef script below installs Ruby 2.2 using a PPA for Ubuntu, this PPA is also recommended for manual installations on Ubuntu.</p>

<h4 id="toc_2">Installation Options</h4>

<ul>
<li>automated installation via Vagrant/Chef (recommended)</li>
<li>manual installation</li>
</ul>

<p>Hosting Lagotto at a Platform as a Service (PaaS) provider such as Heroku or OpenShift is possible, but has not been tested.</p>

<h2 id="toc_3">Configuration options</h2>

<p>Starting with the Lagotto 3.7 release all user-specific configuration options for Rails, as well as for the server configuration and deployment tools Vagrant, Chef and Capistrano are environment variables, and can be stored in a single <code>.env</code> file. You can use multiple <code>.env</code> files, specify the <code>.env</code> file using the <code>DOTENV</code> environment variable, e.g. <code>DOTENV=example</code> for the <code>.env.example</code> example configuration file provided with the application.</p>

<p>More information regarding ENV variables and <code>.env</code> is available <a href="https://github.com/bkeepers/dotenv">here</a>. The following configuration options need to be set:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="c"># Example configuration settings for this application</span>

<span class="nv">APPLICATION</span><span class="o">=</span>lagotto

<span class="nv">RAILS_ENV</span><span class="o">=</span>development

<span class="c"># database settings</span>
<span class="nv">DB_NAME</span><span class="o">=</span>lagotto
<span class="nv">DB_USERNAME</span><span class="o">=</span>vagrant
<span class="nv">DB_PASSWORD</span><span class="o">=</span>
<span class="nv">DB_HOST</span><span class="o">=</span>localhost

<span class="c"># internal name of server</span>
<span class="nv">HOSTNAME</span><span class="o">=</span>lagotto.local

<span class="c"># public name of server</span>
<span class="c"># can be HOSTNAME, or different if load balancer is used</span>
<span class="nv">SERVERNAME</span><span class="o">=</span>lagotto.local

<span class="c"># all instances of server used behind load balancer</span>
<span class="c"># can be HOSTNAME, or comma-delimited string of HOSTNAME</span>
<span class="nv">SERVERS</span><span class="o">=</span>lagotto.local

<span class="c"># name used on navigation bar and in email subject line</span>
<span class="nv">SITENAME</span><span class="o">=</span>Lagotto

<span class="c"># email address for sending emails</span>
<span class="nv">ADMIN_EMAIL</span><span class="o">=</span>admin@example.com

<span class="c"># number of background processes</span>
<span class="nv">CONCURRENCY</span><span class="o">=</span>25

<span class="c"># automatic import via CrossRef API.</span>
<span class="c"># Use &#39;crossref&#39;, &#39;member&#39;, &#39;sample&#39;, &#39;member_sample&#39;, &#39;datacite&#39;, &#39;dataone&#39;, &#39;plos&#39;, or comment out</span>
<span class="c"># IMPORT=</span>

<span class="c"># keys</span>
<span class="c"># run `rake secret` to generate these keys</span>
<span class="nv">API_KEY</span><span class="o">=</span>8897f9349100728d66d64d56bc21254bb346a9ed21954933
<span class="nv">SECRET_KEY_BASE</span><span class="o">=</span>c436de247c988eb5d0908407e700098fc3992040629bb8f98223cd221e94ee4d15626aae5d815f153f3dbbce2724ccb8569c4e26a0f6f663375f6f2697f1f3cf

<span class="c"># mail settings</span>
<span class="nv">MAIL_ADDRESS</span><span class="o">=</span>localhost
<span class="nv">MAIL_PORT</span><span class="o">=</span>25
<span class="nv">MAIL_DOMAIN</span><span class="o">=</span>localhost

<span class="c"># vagrant settings</span>
<span class="nv">PRIVATE_IP</span><span class="o">=</span>10.2.2.4

<span class="nv">AWS_KEY</span><span class="o">=</span>
<span class="nv">AWS_SECRET</span><span class="o">=</span>
<span class="nv">AWS_KEYNAME</span><span class="o">=</span>
<span class="nv">AWS_KEYPATH</span><span class="o">=</span>

<span class="nv">DO_PROVIDER_TOKEN</span><span class="o">=</span>
<span class="nv">DO_SIZE</span><span class="o">=</span>1GB
<span class="nv">SSH_PRIVATE_KEY</span><span class="o">=</span><span class="s1">&#39;~/.ssh/id_rsa&#39;</span>

<span class="c"># user and group who own application repository</span>
<span class="nv">DEPLOY_USER</span><span class="o">=</span>vagrant
<span class="nv">DEPLOY_GROUP</span><span class="o">=</span>vagrant

<span class="c"># mysql server root password for chef</span>
<span class="nv">DB_SERVER_ROOT_PASSWORD</span><span class="o">=</span>EZ<span class="nv">$zspyxF2</span>

<span class="nv">LOG_LEVEL</span><span class="o">=</span>info

<span class="c"># authentication via orcid, github, cas or persona</span>
<span class="nv">OMNIAUTH</span><span class="o">=</span>persona

<span class="nv">GITHUB_CLIENT_ID</span><span class="o">=</span>
<span class="nv">GITHUB_CLIENT_SECRET</span><span class="o">=</span>

<span class="nv">ORCID_CLIENT_ID</span><span class="o">=</span>
<span class="nv">ORCID_CLIENT_SECRET</span><span class="o">=</span>

<span class="nv">CAS_URL</span><span class="o">=</span>
<span class="nv">CAS_INFO_URL</span><span class="o">=</span>
<span class="nv">CAS_PREFIX</span><span class="o">=</span>
</code></pre></div>
<h2 id="toc_4">Automated Installation</h2>

<p>This is the recommended way to install Lagotto. The required applications and libraries will automatically be installed in a self-contained virtual machine running Ubuntu 14.04, using <a href="at%20least%20version%201.7.x">Vagrant</a> and <a href="http://docs.opscode.com/chef_solo.html">Chef Solo</a>.</p>

<p>The first step is to copy <code>.env.example</code> to <code>.env</code> and to set all variables - reasonable defaults are provided for many of them.</p>

<p>Then download and install <a href="http://downloads.vagrantup.com/">Vagrant</a>, and the librarian gem (used to manage Chef cookbooks):</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">gem install librarian
</code></pre></div>
<p>Vagrant needs three additional plugins and will complain if they are missing. The <code>vagrant-omnibus</code> plugin installs Chef on the VM, the <code>vagrant-librarian-chef</code> plugin manages cookbooks, and the <code>vagrant-bindfs</code> plugin improves the performance of shared folders when using Virtualbox.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">vagrant plugin install vagrant-omnibus
vagrant plugin install vagrant-librarian-chef
vagrant plugin install vagrant-bindfs
vagrant plugin install dotenv
vagrant plugin install vagrant-capistrano-push
</code></pre></div>
<p>The following providers have been tested with Lagotto:</p>

<ul>
<li>Virtualbox</li>
<li>VMware Fusion or Workstation</li>
<li>Amazon AWS</li>
<li>Digital Ocean</li>
<li>Rackspace</li>
</ul>

<p>Virtualbox and VMware are for local installations, e.g. on a developer machine, whereas the other options are for cloud installations. With the exception of Virtualbox you need to install the appropriate <a href="https://github.com/mitchellh/vagrant/wiki/Available-Vagrant-Plugins">Vagrant plugin</a> with these providers, e.g. for AWS:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">vagrant plugin install vagrant-aws
</code></pre></div>
<p>The VMware plugin requires a commercial license, all other plugins are freely available as Open Source software.</p>

<p>For Amazon AWS the configuration could look like this:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:aws</span> <span class="k">do</span> <span class="o">|</span><span class="n">aws</span><span class="p">,</span> <span class="n">override</span><span class="o">|</span>
  <span class="c1"># please configure</span>
  <span class="n">aws</span><span class="o">.</span><span class="n">access_key_id</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;AWS_KEY&#39;</span><span class="o">]</span>
  <span class="n">aws</span><span class="o">.</span><span class="n">secret_access_key</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;AWS_SECRET&#39;</span><span class="o">]</span>
  <span class="n">aws</span><span class="o">.</span><span class="n">keypair_name</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;AWS_KEYNAME&#39;</span><span class="o">]</span>
  <span class="n">override</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">private_key_path</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;AWS_KEYPATH&#39;</span><span class="o">]</span>
  <span class="n">override</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HOSTNAME&#39;</span><span class="o">]</span>

  <span class="n">aws</span><span class="o">.</span><span class="n">security_groups</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
  <span class="n">aws</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="s2">&quot;m3.medium&quot;</span>
  <span class="n">aws</span><span class="o">.</span><span class="n">ami</span> <span class="o">=</span> <span class="s2">&quot;ami-9aaa1cf2&quot;</span>
  <span class="n">aws</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="s2">&quot;us-east-1&quot;</span>
  <span class="n">aws</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">Name</span><span class="p">:</span> <span class="s1">&#39;Vagrant Lagotto&#39;</span> <span class="p">}</span>

  <span class="n">override</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;ubuntu&quot;</span>
  <span class="n">override</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box&quot;</span>

  <span class="c1"># Custom parameters for the Lagotto recipe</span>
  <span class="n">chef_overrides</span><span class="o">[</span><span class="s1">&#39;lagotto&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;user&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ubuntu&#39;</span><span class="p">,</span>
    <span class="s1">&#39;group&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ubuntu&#39;</span><span class="p">,</span>
    <span class="s1">&#39;provider&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;aws&#39;</span>
  <span class="p">}</span>

  <span class="n">provision</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">override</span><span class="p">,</span> <span class="n">chef_overrides</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>For Digital Ocean the configuration could look like this:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:digital_ocean</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="p">,</span> <span class="n">override</span><span class="o">|</span>
  <span class="n">override</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HOSTNAME&#39;</span><span class="o">]</span>
  <span class="n">provider</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;DO_PROVIDER_TOKEN&#39;</span><span class="o">]</span>
  <span class="n">provider</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;DO_SIZE&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="s1">&#39;1GB&#39;</span>
  <span class="n">override</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">private_key_path</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;PRIVATE_KEY_PATH&#39;</span><span class="o">]</span>

  <span class="n">override</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s1">&#39;digital_ocean&#39;</span>
  <span class="n">override</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/smdahlen/vagrant-digitalocean/raw/master/box/digital_ocean.box&quot;</span>
  <span class="n">override</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;ubuntu&quot;</span>
  <span class="n">provider</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="s1">&#39;nyc2&#39;</span>
  <span class="n">provider</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="s1">&#39;Ubuntu 14.04 x64&#39;</span>

  <span class="n">provision</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">override</span><span class="p">,</span> <span class="n">chef_overrides</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>All user-specific settings are controlled via ENV variables and the <code>.env</code> file.</p>

<h3 id="toc_5">Cookbooks</h3>

<p>The <a href="https://supermarket.getchef.com/">Chef cookbooks</a> needed by the Lagotto cookbook are managed by <a href="https://github.com/applicationsonline/librarian-chef">librarian-chef</a>, which was installed in a previous step. The required cookbooks are listed in the <code>Cheffile</code>, and are automatically installed into <code>vendor/cookbooks</code>.</p>

<h3 id="toc_6">Installation</h3>

<p>Then install all the required software for Lagotto with:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">git clone git://github.com/lagotto/lagotto.git
<span class="nb">cd </span>lagotto
vagrant up
</code></pre></div>
<p>This can take up to 15 min, future updates with <code>vagrant provision</code> are of course much faster. To get into in the virtual machine, use ssh and then switch to the directory of the application:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">vagrant ssh
<span class="nb">cd</span> /var/www/lagotto/current
</code></pre></div>
<p>This uses the private SSH key provided by you in the <code>Vagrantfile</code> (the default insecure key for local installations using Virtualbox is <code>~/.vagrant.d/insecure_private_key</code>). The <code>vagrant</code> user has sudo privileges. The MySQL password is stored as <code>DB_PASSWORD</code> in the <code>.env</code> file. The database servers can be reached from the virtual machine or via port forwarding. Vagrant syncs the folder on the host containing the checked out Lagotto git repo with the folder <code>/var/www/lagotto/current</code> on the guest.</p>

<h2 id="toc_7">Manual installation</h2>

<p>These instructions assume a fresh installation of Ubuntu 14.04 and a user with sudo privileges. Installation on other Unix/Linux platforms should be similar, and Lagotto runs on several production systems with RHEL and CentOS.</p>

<h4 id="toc_8">Add PPAs/repositories to install more recent versions of Ruby and CouchDB, and Nginx/Passenger</h4>

<p>We only need one Ruby version and manage gems with bundler, so there is no need to install <code>rvm</code> or <code>rbenv</code>. We optionally want to install the latest CouchDB version from the official PPA (needed for the twitter_search, pmc and f1000 sources), and we want to install Nginx precompiled with Passenger.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 561F9B9CAC40B2F7
sudo apt-get install apt-transport-https ca-certificates -y
sudo apt-get install python-software-properties -y

sudo apt-add-repository ppa:brightbox/ruby-ng
sudo add-apt-repository ppa:couchdb/stable

<span class="nb">echo</span> <span class="s1">&#39;deb https://oss-binaries.phusionpassenger.com/apt/passenger trusty main&#39;</span> <span class="p">|</span> sudo tee --append /etc/apt/sources.list &gt; /dev/null
</code></pre></div>
<h4 id="toc_9">Update package lists</h4>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo apt-get update
</code></pre></div>
<h4 id="toc_10">Install Ruby and required packages</h4>

<p>Also install the <code>make</code>, <code>curl</code> and <code>git</code> packages, the <code>libmysqlclient-dev</code> library required by the <code>myslq2</code> gem, and <code>nodejs</code> as Javascript runtime. When running Lagotto on a local machine we also want to install <code>avahi-daemon</code> and <code>libnss-mdns</code>for zeroconf networking - this allows us to reach the server at <code>http://lagotto.local</code>.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo apt-get install ruby2.2 ruby2.2-dev make curl git libmysqlclient-dev nodejs avahi-daemon libnss-mdns -y
</code></pre></div>
<h4 id="toc_11">Install databases</h4>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo apt-get install couchdb mysql-server redis-server -y
</code></pre></div>
<h4 id="toc_12">Install Memcached</h4>

<p>Memcached is used to cache requests (in particular API requests), and the default configuration can be used.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo apt-get install memcached -y
</code></pre></div>
<h4 id="toc_13">Install Postfix</h4>

<p>Postfix is used to send reports via email. The configuration is done in the <code>.env</code> file. More information can be found <a href="http://guides.rubyonrails.org/action_mailer_basics.html">here</a>.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo apt-get install postfix -y
</code></pre></div>
<h4 id="toc_14">Install Nginx with Passenger</h4>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo apt-get install nginx-full passenger -y
</code></pre></div>
<p>Edit <code>/etc/nginx/nginx.conf</code> and uncomment <code>passenger_root</code> and <code>passenger_ruby</code>.</p>

<h4 id="toc_15">Set up Nginx virtual host</h4>

<p>Please set <code>server_name</code> if you have set up more than one virtual host. Use <code>passenger_app_env development</code> to use the Rails development environment. Edit the file <code>/etc/nginx/sites-enabled/default</code> or - if you use multiple hosts - create the file <code>/etc/nginx/sites-enabled/lagotto.conf</code> with the following contents:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">server {
  listen 80 default_server;
  server_name EXAMPLE.ORG;
  root /var/www/lagotto/public;
  access_log /var/log/nginx/lagotto.access.log;
  passenger_enabled on;
  passenger_app_env production;
}
</code></pre></div>
<h4 id="toc_16">Install Lagotto code</h4>

<p>You may have to set the permissions first, depending on your server setup. Passenger by default is run by the user who owns <code>config.ru</code>.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">mkdir -p /var/www
sudo chmod 755 /var/www
<span class="nb">cd</span> /var/www
git clone git://github.com/lagotto/lagotto.git
</code></pre></div>
<h4 id="toc_17">Install Bundler and Ruby gems required by the application</h4>

<p>Bundler is a tool to manage dependencies of Ruby applications: <a href="http://gembundler.com">http://gembundler.com</a>.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo gem install bundler

<span class="nb">cd</span> /var/www/lagotto
bundle install
</code></pre></div>
<h4 id="toc_18">Install Node, Bower, and npm and bower modules required by the application</h4>

<p><a href="http://bower.io/">Bower</a> is used to install frontend dependencies (Javascript and CSS libraries). Because of permission issues we don&#39;t install Bower globally. Bower modules are installed via a npm postinstall hook.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nb">cd</span> /var/www/lagotto/frontend
npm install
</code></pre></div>
<h4 id="toc_19">Install Lagotto databases</h4>

<p>We just setup an empty database for CouchDB (optional). With MySQL we also include all data to get started, including a default user account (<code>DB_USERNAME</code> from your <code>.env</code> file). Use <code>RAILS_ENV=production</code> in your <code>.env</code> file if you set up Passenger to run in the production environment.</p>

<p>It is possible to connect Lagotto to MySQL unning on a different server, please change <code>DB_HOST</code> in your <code>.env</code> file accordingly. We are using the default installation for redis.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nb">cd</span> /var/www/lagotto
rake db:setup <span class="nv">RAILS_ENV</span><span class="o">=</span>production
</code></pre></div>
<h4 id="toc_20">Restart Nginx</h4>

<p>We are making <code>lagotto</code> the default site.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo service nginx restart
</code></pre></div>
<p>You can now access the Lagotto application with your web browser at the name or IP address of your Ubuntu installation.</p>

<h2 id="toc_21">Using PostgreSQL instead of MySQL</h2>

<p>The instructions above are for using MySQL, but Lagotto can also be installed with PostgreSQL. Change the database adapter in <code>config/database.yml</code> to use PostgreSQL by adding <code>DB=postgres</code> to your <code>.env</code> file.</p>
<div class="highlight"><pre><code class="yaml language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">mysql</span><span class="p-Indicator">:</span> <span class="nl">&amp;mysql</span>
  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mysql2</span>

<span class="l-Scalar-Plain">postgresql</span><span class="p-Indicator">:</span> <span class="nl">&amp;postgres</span>
  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgresql</span>
  <span class="l-Scalar-Plain">pool</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
  <span class="l-Scalar-Plain">min_messages</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ERROR</span>

<span class="l-Scalar-Plain">defaults</span><span class="p-Indicator">:</span> <span class="nl">&amp;defaults</span>
  <span class="l-Scalar-Plain">pool</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
  <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5000</span>
  <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DB_NAME&#39;] %&gt;</span>
  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DB_USERNAME&#39;] %&gt;</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DB_PASSWORD&#39;] %&gt;</span>
  <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DB_HOST&#39;] %&gt;</span>

  <span class="l-Scalar-Plain">&lt;&lt;</span><span class="p-Indicator">:</span> <span class="err">*</span><span class="l-Scalar-Plain">&lt;%= ENV[&#39;DB&#39;] || &quot;mysql&quot; %&gt;</span>

  <span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">&lt;&lt;</span><span class="p-Indicator">:</span> <span class="nv">*defaults</span>

  <span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">&lt;&lt;</span><span class="p-Indicator">:</span> <span class="nv">*defaults</span>

  <span class="l-Scalar-Plain">production</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">&lt;&lt;</span><span class="p-Indicator">:</span> <span class="nv">*defaults</span>
</code></pre></div>
<p>Make sure the <code>pg</code> gem is included in your <code>Gemfile</code> and you have installed Postgres and the required libraries with</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">sudo apt-get install postgresql libpq-dev -y
</code></pre></div>
<h2 id="toc_22">Running Lagotto on multiple servers</h2>

<p>Lagotto was developed to run on a single server, but most components scale to multiple servers. When running Lagotto on multiple servers, make sure that:</p>

<ul>
<li>the name of load balancer is set as <code>SERVERNAME</code> in <code>.env</code></li>
<li>memcached should be set up as a cluster by adding a <code>MEMCACHE_SERVERS</code> comma-separated list with all Lagotto servers behind the load balancer to <code>.env</code>, e.g. <code>MEMCACHE_SERVERS=example1.org,example2.org</code></li>
<li>workers should run on only one server, e.g. the server with the capistrano <code>:db</code> role</li>
<li>database maintenance rake tasks should run on only one server, capistrano defaults to install the cron jobs only for the <code>:db</code> role.</li>
<li>mail services (sending emails) should run on only one server. They are part of the database maintenance tasks, so by default run only on the server with the <code>:db</code> role.</li>
</ul>
